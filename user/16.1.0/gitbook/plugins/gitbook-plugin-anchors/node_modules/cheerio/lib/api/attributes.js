var _=require("lodash"),utils=require("../utils"),isTag=utils.isTag,domEach=utils.domEach,hasOwn=Object.prototype.hasOwnProperty,camelCase=utils.camelCase,cssCase=utils.cssCase,rspace=/\s+/,dataAttrPrefix="data-",primitives={"null":null,"true":!0,"false":!1},rboolean=/^(?:autofocus|autoplay|async|checked|controls|defer|disabled|hidden|loop|multiple|open|readonly|required|scoped|selected)$/i,rbrace=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,getAttr=function(a,b){return a&&isTag(a)?(a.attribs||(a.attribs={}),b?hasOwn.call(a.attribs,b)?rboolean.test(b)?b:a.attribs[b]:void 0:a.attribs):void 0},setAttr=function(a,b,c){null===c?removeAttribute(a,b):a.attribs[b]=c+""};exports.attr=function(a,b){return"object"==typeof a||void 0!==b?"function"==typeof b?domEach(this,function(c,d){setAttr(d,a,b.call(d,c,d.attribs[a]))}):domEach(this,function(c,d){isTag(d)&&("object"==typeof a?_.each(a,function(a,b){d.attribs[b]=a+""}):setAttr(d,a,b))}):getAttr(this[0],a)};var setData=function(a,b,c){return"object"==typeof b?_.extend(a.data,b):void("string"==typeof b&&void 0!==c?a.data[b]=c:"object"==typeof b&&_.exend(a.data,b))},readData=function(a,b){var c,d,e,f,g,h,i,j=1===arguments.length;for(j?(c=Object.keys(a.attribs).filter(function(a){return a.slice(0,dataAttrPrefix.length)===dataAttrPrefix}),e=c.map(function(a){return camelCase(a.slice(dataAttrPrefix.length))})):(c=[dataAttrPrefix+cssCase(b)],e=[b]),h=0,i=c.length;i>h;++h)if(d=c[h],f=e[h],hasOwn.call(a.attribs,d)){if(g=a.attribs[d],hasOwn.call(primitives,g))g=primitives[g];else if(g===String(Number(g)))g=Number(g);else if(rbrace.test(g))try{g=JSON.parse(g)}catch(k){}a.data[f]=g}return j?a.data:g};exports.data=function(a,b){var c=this[0];if(c&&isTag(c))return c.data||(c.data={}),a?"object"==typeof a||void 0!==b?(domEach(this,function(c,d){setData(d,a,b)}),this):hasOwn.call(c.data,a)?c.data[a]:readData(c,a):readData(c)},exports.val=function(a){var b=0===arguments.length,c=this[0];if(c)switch(c.name){case"textarea":return this.text(a);case"input":switch(this.attr("type")){case"radio":return b?this.attr("value"):(this.attr("value",a),this);default:return this.attr("value",a)}return;case"select":var d,e=this.find("option:selected");if(void 0===e)return;if(!b){if(!this.attr().hasOwnProperty("multiple")&&"object"==typeof a)return this;"object"!=typeof a&&(a=[a]),this.find("option").removeAttr("selected");for(var f=0;f<a.length;f++)this.find('option[value="'+a[f]+'"]').attr("selected","");return this}return d=e.attr("value"),this.attr().hasOwnProperty("multiple")&&(d=[],domEach(e,function(a,b){d.push(b.attribs.value)})),d;case"option":return b?this.attr("value"):(this.attr("value",a),this)}};var removeAttribute=function(a,b){a.attribs&&hasOwn.call(a.attribs,b)&&delete a.attribs[b]};exports.removeAttr=function(a){return domEach(this,function(b,c){removeAttribute(c,a)}),this},exports.hasClass=function(a){return _.any(this,function(b){var c,d=b.attribs,e=d&&d["class"],f=-1;if(e)for(;(f=e.indexOf(a,f+1))>-1;)if(c=f+a.length,(0===f||rspace.test(e[f-1]))&&(c===e.length||rspace.test(e[c])))return!0})},exports.addClass=function(a){if("function"==typeof a)return domEach(this,function(b,c){var d=c.attribs["class"]||"";exports.addClass.call([c],a.call(c,b,d))});if(!a||"string"!=typeof a)return this;for(var b=a.split(rspace),c=this.length,d=0;c>d;d++)if(isTag(this[d])){var e,f,g=getAttr(this[d],"class");if(g){f=" "+g+" ",e=b.length;for(var h=0;e>h;h++){var i=b[h]+" ";f.indexOf(" "+i)<0&&(f+=i)}setAttr(this[d],"class",f.trim())}else setAttr(this[d],"class",b.join(" ").trim())}return this};var splitClass=function(a){return a?a.trim().split(rspace):[]};exports.removeClass=function(a){var b,c,d;return"function"==typeof a?domEach(this,function(b,c){exports.removeClass.call([c],a.call(c,b,c.attribs["class"]||""))}):(b=splitClass(a),c=b.length,d=0===arguments.length,domEach(this,function(a,e){if(isTag(e))if(d)e.attribs["class"]="";else{for(var f,g,h=splitClass(e.attribs["class"]),i=0;c>i;i++)f=h.indexOf(b[i]),f>=0&&(h.splice(f,1),g=!0,i--);g&&(e.attribs["class"]=h.join(" "))}}))},exports.toggleClass=function(a,b){if("function"==typeof a)return domEach(this,function(c,d){exports.toggleClass.call([d],a.call(d,c,d.attribs["class"]||"",b),b)});if(!a||"string"!=typeof a)return this;for(var c,d,e=a.split(rspace),f=e.length,g="boolean"==typeof b?b?1:-1:0,h=this.length,i=0;h>i;i++)if(isTag(this[i])){c=splitClass(this[i].attribs["class"]);for(var j=0;f>j;j++)d=c.indexOf(e[j]),g>=0&&0>d?c.push(e[j]):0>=g&&d>=0&&c.splice(d,1);this[i].attribs["class"]=c.join(" ")}return this},exports.is=function(a){return a?this.filter(a).length>0:!1};